#!/bin/sh

echo "[*] Creating test cron job for reboot in 2 minutes..."

# Get current time + 2 minutes
H=$(date +%H)
M=$(date +%M)
M_NEXT=$(( (10#$M + 2) % 60 ))
if [ "$M_NEXT" -lt "$M" ]; then
  H=$(( (10#$H + 1) % 24 ))
fi

# Pad zeros
M_PAD=$(printf "%02d" $M_NEXT)
H_PAD=$(printf "%02d" $H)

echo "[*] Scheduling reboot at $H_PAD:$M_PAD..."

# Create reboot cron job
cat <<EOF > /usr/lib/micron.d/reboot-now
$((M_NEXT - 1)) $H_PAD * * * /usr/bin/logger 'AP will reboot in 1 minute'
$M_PAD $H_PAD * * * /sbin/reboot
EOF

chmod 644 /usr/lib/micron.d/reboot-now

# Reload micrond
killall micrond
/usr/sbin/micrond /usr/lib/micron.d &

echo "[âœ“] Job set. Watching logs now:"
logread -f | grep --line-buffered 'AP will reboot'
