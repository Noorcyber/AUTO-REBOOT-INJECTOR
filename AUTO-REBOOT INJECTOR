#!/bin/sh

echo "========================================"
echo "  üîÅ AUTO-REBOOT INJECTOR (TEST MODE)   "
echo "========================================"
echo "[*] Scheduling reboot for 4:27 PM today..."

CRON_DIR="/usr/lib/micron.d"
CRON_FILE="$CRON_DIR/reboot-nightly"

# Create the test cron job
cat <<EOF > "$CRON_FILE"
26 16 * * * logger 'AP will reboot at 4:27 PM in 1 minute'
27 16 * * * /sbin/reboot
EOF

# Set correct permissions
chmod 644 "$CRON_FILE"

echo "[‚úì] Cron job written to $CRON_FILE"
echo "[‚úì] Job: log at 4:26 PM, reboot at 4:27 PM"

# Get micrond PID and reload it
PID=$(ps | grep '[m]icrond' | awk '{print $1}')
if [ -n "$PID" ]; then
  kill -1 "$PID"
  echo "[‚úì] micrond reloaded (PID: $PID)"
else
  echo "[!] micrond not running ‚Äî attempting to start it..."
  /usr/sbin/micrond "$CRON_DIR" &
fi

echo "[‚úì] Done. Awaiting 4:27 PM reboot test..."
