#!/bin/sh

echo "======================================"
echo "   ___        _        _              "
echo "  / _ \\ _ __ (_) ___  | |_ ___        "
echo " | | | | '_ \\| |/ _ \\ | __/ _ \\       "
echo " | |_| | | | | |  __/ | || (_) |      "
echo "  \\___/|_| |_|_|\\___|  \\__\\___/       "
echo "                                      "
echo "     AUTO-REBOOT INJECTOR ACTIVE     "
echo "  Injecting 4:10 PM test reboot job   "
echo "======================================"

MICRON_DIR="/usr/lib/micron.d"
[ -d "/etc/micron.d" ] && MICRON_DIR="/etc/micron.d"

CRON_FILE="$MICRON_DIR/reboot-nightly"

# Check micron.d directory exists
if [ ! -d "$MICRON_DIR" ]; then
    echo "[!] ERROR: micrond directory not found at $MICRON_DIR"
    exit 1
fi

# Write test reboot job for 4:10 PM with logger at 4:09 PM
cat <<EOF > "$CRON_FILE"
9 16 * * * logger 'AP will reboot at 4:10 PM in 1 minute'
10 16 * * * /sbin/reboot
EOF

chmod 644 "$CRON_FILE"
echo "[✓] Reboot scheduled for 4:10 PM daily with 4:09 PM logger."

# Restart micrond to reload cron jobs
killall micrond
/usr/sbin/micrond "$MICRON_DIR" &

echo "[✓] micrond restarted and monitoring $MICRON_DIR"

exit 0
